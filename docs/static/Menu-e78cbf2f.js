import{s as ze,aj as We,D as J,a as le,b as oe,T as Pe,ak as ne,e as re,B as O,al as ge,am as g,an as pe,ao as Te,d as ue,ap as Me,v as m,aq as De,ar as j,M as Oe,E as $e,as as _e,at as Ne,au as je,av as fe,ab as qe,aw as Xe,w as u,ax as Je,S as Ve,G as Ie,j as V,ay as He,az as Ee,aA as xe,V as Ge,aB as me,aC as Ye,N as Fe,aD as Ke,aE as Qe,aF as Ze,aG as et,aH as tt,aI as nt,a5 as at,W as lt,aJ as ot}from"./@mui-dc9e1ba3.js";import{g as ae,i as K,m as Ae,e as rt,n as st,a as S,b as M,I as Se,s as it,c as ct,d as dt,f as D,h as be,j as Re,k as mt,S as ut,l as ht,o as gt,L as pt,r as ft,p as Et,q as we,t as xt,C as St,u as bt,v as wt,w as Ct}from"./index-e193de46.js";import{o as Be}from"./mobx-react-1c6baff6.js";import{u as H}from"./react-i18next-0e366d71.js";import"./react-2b221fbb.js";import"./clsx-0839fdbe.js";import"./@emotion-22635a5b.js";import"./hoist-non-react-statics-23d96a9a.js";import"./react-is-e8e5dbb3.js";import"./@babel-bc930cec.js";import"./stylis-79144faa.js";import"./react-transition-group-45d74422.js";import"./@popperjs-61ffd834.js";import"./prop-types-4dcdfe56.js";import"./react-dom-d3bdc6a0.js";import"./monaco-editor-5cf1114e.js";/* empty css                      */import"./i18next-c75e253c.js";import"./@monaco-editor-863e66c9.js";import"./state-local-dd516420.js";import"./react-resizable-95d32b79.js";import"./react-draggable-e660ef73.js";import"./i18next-browser-languagedetector-ac00b891.js";import"./mobx-3741033e.js";import"./mobx-react-lite-1ad052b5.js";import"./use-sync-external-store-b84fba6b.js";const yt=window.React,he=ze(r=>yt.createElement(We,{elevation:0,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},...r}))(({theme:r})=>({"& .MuiPaper-root":{borderRadius:6,marginTop:r.spacing(1),color:r.palette.mode==="light"?"rgb(55, 65, 81)":r.palette.grey[300],"& .MuiMenu-list":{padding:"4px 0"},"& .MuiMenuItem-root":{"& .MuiSvgIcon-root":{fontSize:20,color:r.palette.mode==="light"?"rgb(55, 65, 81)":r.palette.grey[300],marginRight:r.spacing(1.5)}}}})),E=window.React;function kt(r){const{t}=H();E.useRef();let[n,a]=E.useState(!1);const[o,l]=E.useState("https://bigonion.cn"),[x,b]=E.useState(!1);let k=z=>{a(()=>!1),r.onClick(z)},v=async z=>{ae()};const B=z=>U=>{U.stopPropagation(),window.location.href=z},f=()=>{navigator.clipboard.writeText(o).then(()=>{b(!0),setTimeout(()=>b(!1),2e3)}).catch(z=>{console.error("Failed to copy URL:",z)})};return E.createElement(E.Fragment,null,E.createElement(J,{fullWidth:!0,maxWidth:"sm",open:n,onClose:k},E.createElement(le,null,"真·分享"),E.createElement(oe,null,E.createElement(Pe,{title:x?"已复制!":"点击复制"},E.createElement(ne,{value:o,variant:"outlined",fullWidth:!0,InputProps:{readOnly:!0},onClick:f}))),E.createElement(re,null,E.createElement(O,{onClick:v},"创建分享链接"))),E.createElement(ge,null),t("t-share"),E.createElement(he,{style:{width:"fitContent"},anchorOrigin:{vertical:-5,horizontal:12},id:"demo-customized-menu",MenuListProps:{"aria-labelledby":"demo-customized-button"},elevation:24,anchorEl:r.anchorEl,open:r.open,onClick:r.onClick},E.createElement(g,{onClick:z=>{z.stopPropagation(),a(!0)},disabled:!0,disableRipple:!0},E.createElement(ge,null),"真·分享"),E.createElement(g,{onClick:B("weixin://dl/scan"),disableRipple:!0},E.createElement(pe,null),"WeChat"),E.createElement(g,{onClick:B("tg://"),disableRipple:!0},E.createElement(pe,null),"Telegram"),E.createElement(g,{onClick:B("mailto:bigonion@bigonion.cn?subject=你的主题&body=你的邮件内容"),disableRipple:!0},E.createElement(Te,null),"Email")))}const vt=(await K("https://cdn.jsdmirror.com/npm/bigonion-kit@0.12.6/esm/kit.min.js")).default;function zt(){let r=ae()??"";vt.sleep(250).then(()=>{var t=document.createElement("a");t.href="data:text/plain;charset=utf-8,"+encodeURIComponent(r),t.download="text.md",t.click()})}const d=window.React;function Mt(r){const{t}=H();let n=r.closeExportMenu,[a,o]=d.useState(!1),l=f=>{console.log(f),n(f),o(()=>!1)},x=d.useRef();const[b,k]=d.useState(3),v=f=>{f.stopPropagation(),k(f.target.value)};let B=f=>{l(f);let z=x.current.value;rt(b??4,z??"md_snapshot.png"),r.closeMenu(f),st("导出成功！","Beta版本",{kind:"info",position:"topRight"})};return d.createElement(d.Fragment,null,d.createElement(J,{className:"avoid",onClose:l,open:a,fullWidth:!0,maxWidth:"sm"},d.createElement("div",{onClick:f=>{f.stopPropagation()}},d.createElement(le,null,"导出设置"),d.createElement(oe,null,d.createElement(ue,null,"请选择图片清晰度"),d.createElement("br",null),d.createElement(Me,{fullWidth:!0},d.createElement(m,null,d.createElement(De,{id:"demo-simple-select-label"},"图片清晰度"),d.createElement(j,{label:"图片清晰度",defaultValue:"4",defaultChecked:!0,fullWidth:!0,onChange:v},d.createElement(g,{value:"1"},"1 (比较模糊,体积轻巧)"),d.createElement(g,{value:"2"},"2 (有些模糊)"),d.createElement(g,{value:"4"},"3 (默认,适中,推荐)"),d.createElement(g,{value:"6"},"4 (比较清晰,体积稍大)"),d.createElement(g,{value:"10"},"5 (超鸡无敌霹雳霸清晰,体积较大)"))),d.createElement(m,{marginX:"8px"},d.createElement(ne,{inputRef:x,margin:"dense",id:"export_img_name",defaultValue:"md_snapshot.png",label:"导出的文件名",type:"text",fullWidth:!0,variant:"standard",placeholder:"md_snapshot.png"})))),d.createElement(re,null,d.createElement(O,{onClick:l},"取消"),d.createElement(O,{onClick:B},"确认导出")))),d.createElement(Oe,null),t("t-export"),d.createElement(he,{style:{width:"fitContent"},anchorOrigin:{vertical:-5,horizontal:12},id:"demo-customized-menu",MenuListProps:{"aria-labelledby":"demo-customized-button"},elevation:24,anchorEl:r.anchorEl,open:r.open,onClick:f=>{n(f)}},d.createElement(g,{onClick:()=>{Ae()},disableRipple:!0},d.createElement($e,null),t("t-export-pdf")),d.createElement(g,{onClick:f=>{o(!0),n(f)},disableRipple:!0},d.createElement(_e,null),t("t-export-image")),d.createElement(g,{onClick:()=>{zt()},disableRipple:!0},d.createElement(Ne,null),t("t-export-markdown"))))}const $=window.React;function It(r){r.preventDefault()}function Ft(){return $.createElement(m,{sx:{marginBottom:"5px"},role:"presentation",onClick:It},$.createElement(je,{"aria-label":"breadcrumb"},$.createElement(fe,{underline:"hover",sx:{display:"flex",alignItems:"center"},color:"inherit",href:"/"},$.createElement(qe,{sx:{mr:.5},fontSize:"inherit"}),"MUI"),$.createElement(fe,{underline:"hover",sx:{display:"flex",alignItems:"center"},color:"inherit",href:"/material-ui/getting-started/installation/"},$.createElement(Xe,{sx:{mr:.5},fontSize:"inherit"}),"Basic"),$.createElement(u,{sx:{display:"flex",alignItems:"center"},color:"text.primary"},$.createElement(Je,{sx:{mr:.5},fontSize:"inherit"}),"Theme")))}let At=ze(Ve)(({theme:r})=>({width:62,height:34,padding:7,"& .MuiSwitch-switchBase":{margin:1,padding:0,transform:"translateX(6px)","&.Mui-checked":{color:"#fff",transform:"translateX(22px)","& .MuiSwitch-thumb:before":{backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 20 20"><path fill="${encodeURIComponent("#fff")}" d="M4.2 2.5l-.7 1.8-1.8.7 1.8.7.7 1.8.6-1.8L6.7 5l-1.9-.7-.6-1.8zm15 8.3a6.7 6.7 0 11-6.6-6.6 5.8 5.8 0 006.6 6.6z"/></svg>')`},"& + .MuiSwitch-track":{opacity:1,backgroundColor:r.palette.mode==="dark"?"#8796A5":"#aab4be"}}},"& .MuiSwitch-thumb":{backgroundColor:r.palette.mode==="dark"?"#003892":"#001e3c",width:32,height:32,"&::before":{content:"''",position:"absolute",width:"100%",height:"100%",left:0,top:0,backgroundRepeat:"no-repeat",backgroundPosition:"center",backgroundImage:`url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" height="20" width="20" viewBox="0 0 20 20"><path fill="${encodeURIComponent("#fff")}" d="M9.305 1.667V3.75h1.389V1.667h-1.39zm-4.707 1.95l-.982.982L5.09 6.072l.982-.982-1.473-1.473zm10.802 0L13.927 5.09l.982.982 1.473-1.473-.982-.982zM10 5.139a4.872 4.872 0 00-4.862 4.86A4.872 4.872 0 0010 14.862 4.872 4.872 0 0014.86 10 4.872 4.872 0 0010 5.139zm0 1.389A3.462 3.462 0 0113.471 10a3.462 3.462 0 01-3.473 3.472A3.462 3.462 0 016.527 10 3.462 3.462 0 0110 6.528zM1.665 9.305v1.39h2.083v-1.39H1.666zm14.583 0v1.39h2.084v-1.39h-2.084zM5.09 13.928L3.616 15.4l.982.982 1.473-1.473-.982-.982zm9.82 0l-.982.982 1.473 1.473.982-.982-1.473-1.473zM9.305 16.25v2.083h1.389V16.25h-1.39z"/></svg>')`}},"& .MuiSwitch-track":{opacity:1,backgroundColor:r.palette.mode==="dark"?"#8796A5":"#aab4be",borderRadius:20/2}}));const e=window.React,Rt=(await K("https://cdn.jsdmirror.com/npm/mermaid@10/dist/mermaid.esm.min.mjs")).default,Ce=(await K("https://cdn.jsdmirror.com/npm/bigonion-kit@0.12.6/esm/kit.min.js")).default,P={transition:"background-color 0.4s ease, box-shadow 0.4s ease",position:"relative",padding:"5px",borderRadius:"3px",display:"flex",flexDirection:"column",mt:"10px",mb:"5px",ml:"0px",pl:"25px",willChange:"background-color, box-shadow","&::before":{content:'""',position:"absolute",left:0,top:0,height:"100%",width:4,backgroundColor:"transparent",transition:"background-color 0.2s cubic-bezier(0.5, 0.05, 1, 0.5)"}},I=r=>({"&:hover::before":{backgroundColor:S()==="light"?"#840084":"#d2d2d2"},"&:hover":{backgroundColor:S()==="light"?"#EAEAEA":"#393939",boxShadow:"0px 4px 12px rgba(20, 15, 15, 0.1)"}}),Bt=Be(function(){const{t,i18n:n}=H();S();const a=Ie(),o={...P,transition:"background-color 2s ease, box-shadow 0.4s ease","&::before":{...P["&::before"],transition:"background-color 0.24s ease 0.1s"}},l={color:a.palette.info.contrastText??"#8B8A8A",fontSize:"0.79rem",fontWeight:500,mb:"5px"},[x,b]=e.useState(!1),k=i=>{D({advanced:{imageSettings:{...M().advanced.imageSettings,modePrefer:i.target.value==="folder"?"folder":"vf"}}})},v=i=>{D({advanced:{imageSettings:{...M().advanced.imageSettings,basicStyle:i.target.value}}})},B=i=>{D({advanced:{imageSettings:{...M().advanced.imageSettings,imgStorePath:i.target.value}}})};function f(i,y){const Y=document.querySelector(".markdown-body");y?(be("dark"),b(i.target.checked),Y.style.cssText=""):(be("light"),b(i.target.checked))}function z(i,y){y?D({basic:{syncScroll:!0}}):D({basic:{syncScroll:!1}})}function U(i){D({basic:{speechLanguage:i.target.value}})}function T(i){D({basic:{fontSize:i.target.value}}),document.getElementsByClassName("fontSizeStyle")&&(Ce.removeAddedStyle("fontSizeStyle"),Ce.addStyle(`
      .markdown-body p,
      .markdown-body ol,
      .markdown-body li,
      .markdown-body div {
          font-size: ${M().basic.fontSize}px;
      }
        `,"fontSizeStyle"))}function N(i){D({basic:{editorAutoWrap:i.target.value===1}}),window.editor.updateOptions({wordWrap:M().basic.editorAutoWrap?"on":"off"})}function q(i){D({basic:{fontFamily:i.target.value===1?"Times New Roman":'-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji"'}})}function G(i){let y=i.target.value;n.changeLanguage(i.target.value),document.documentElement.lang=i.target.value,Re({memorable:{languageChanged:!0}}),D({basic:{language:y}})}function X(i){D({advanced:{mermaidTheme:i.target.value}}),Rt.init({theme:i.target.value}),mt()}return e.useEffect(()=>{b(S()==="dark")},[S()]),e.createElement(e.Fragment,null,e.createElement(m,{className:"transparent-scrollbar",sx:{width:"100%",padding:"1rem",display:"flex",flexDirection:"column",fontSize:"0.89rem",maxHight:"200px",overflowY:"scroll"}},e.createElement(u,{id:"settings_1_x",sx:{fontSize:"30px",fontWeight:"700"}},"基础设置"),e.createElement(V,null),e.createElement(m,{id:"settings_1_1",sx:{...P,...I(S())}},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Theme"),e.createElement(u,{sx:l},"更改编辑器的主题"),e.createElement(At,{checked:x,size:"small",inputProps:{"aria-label":"controlled"},onChange:f})),e.createElement(m,{id:"settings_1_2",sx:{...P,...I(S())}},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Language"),e.createElement(u,{sx:l},"更改编辑器的语言"),e.createElement(j,{value:M().basic.language??"zh",defaultChecked:!0,size:"small",color:"primary",onChange:G},e.createElement(g,{value:"zh"},"中文"),e.createElement(g,{value:"en"},"English"))),e.createElement(ye,{id:"settings_1_3",content:"编辑器设置"}),e.createElement(m,{sx:{...P,...I(S())},id:"settings_1_2"},e.createElement(m,{sx:{...o,...I(S())}},e.createElement(m,{className:"FLEX ROW"},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Font Size")),e.createElement(u,{sx:l},"更改渲染后文字字体大小"),e.createElement(j,{value:M().basic.fontSize,defaultChecked:!0,fullWidth:!0,size:"small",onChange:T},[...Array(10).keys()].map(i=>{const y=8+i*2;return e.createElement(g,{key:y,value:y},y," px")}))),e.createElement(m,{sx:{...o,...I(S())}},e.createElement(m,{className:"FLEX ROW"},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Font Family")),e.createElement(u,{sx:l},"更改渲染后文字字体"),e.createElement(j,{value:M().basic.fontFamily==="Times New Roman"?1:0,defaultChecked:!0,fullWidth:!0,size:"small",onChange:q},e.createElement(g,{value:0},"Defualt"),e.createElement(g,{value:1},"Times New Roman"))),e.createElement(m,{sx:{...P,...I(S())}},e.createElement(m,{className:"FLEX ROW"},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Synchronous Scrolling")),e.createElement(u,{sx:l},"同步滚动左边编辑区和预览区域。"),e.createElement(Se,{checked:M().basic.syncScroll,size:"small",inputProps:{"aria-label":"controlled"},onChange:z})),e.createElement(m,{sx:{...P,...I(S())}},e.createElement(m,{className:"FLEX ROW"},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Editor Auto Wrap")),e.createElement(u,{sx:l},"是否开启编辑器自动换行"),e.createElement(j,{value:M().basic.editorAutoWrap?1:0,defaultChecked:!0,fullWidth:!0,size:"small",onChange:N},e.createElement(g,{value:1},"On"),e.createElement(g,{value:0},"OFF")))),e.createElement(m,{id:"settings_1_4",sx:{...P,...I(S())}},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Speech To Text"),e.createElement(u,{sx:l},"选择语音转文字的识别语言"),e.createElement(j,{value:M().basic.speechLanguage??"zh-CN",defaultChecked:!0,fullWidth:!0,size:"small",onChange:U},it.map((i,y)=>e.createElement(g,{key:y,value:i[0]},i[1])))),e.createElement(u,{id:"settings_2_x",sx:{mt:"20px",fontSize:"30px",fontWeight:"700"}},"高级设置（施工中）"),e.createElement(V,null),e.createElement(m,{id:"settings_2_1",sx:{...P,...I(S())}},e.createElement(u,{sx:{fontSize:"0.89rem",fontWeight:500}},"Export Settings"),e.createElement(u,{sx:l},"更改导出设置(施工中)"),e.createElement(Se,{disabled:!0,size:"small",inputProps:{"aria-label":"controlled"}})),e.createElement(m,{sx:{...P,...I(S())}},e.createElement(u,{id:"settings_2_2",sx:{fontSize:"0.89rem",fontWeight:500}},"Mermaid Theme Configs"),e.createElement(u,{sx:l},"Mermaid流程图主题"),e.createElement(j,{value:M().advanced.mermaidTheme??"default",defaultChecked:!0,fullWidth:!0,size:"small",color:"primary",onChange:X},ct.map((i,y)=>e.createElement(g,{key:y,value:i},dt[y])))),e.createElement(ye,{id:"settings_2_3",content:"图片设置"}),e.createElement(m,{sx:{...P,...I(S())}},e.createElement(m,{sx:{...o,...I(S())}},e.createElement(u,{id:"settings_2_3",sx:{fontSize:"0.89rem",fontWeight:500}},"Image Storage Mode Preference (Pasting)"),e.createElement(u,{sx:l},"选择粘贴图片优先存储在浏览器/文件夹"),e.createElement(Me,{sx:{transition:"inherit"}},e.createElement(He,{value:M().advanced.imageSettings.modePrefer,onChange:k},e.createElement(Ee,{value:"folder",control:e.createElement(xe,{sx:{"& .MuiSvgIcon-root":{fontSize:22,color:"#65C466"}}}),label:"本地文件夹 (Prefer In Local Folder)"}),e.createElement(Ee,{value:"vf",control:e.createElement(xe,{sx:{"& .MuiSvgIcon-root":{fontSize:22,color:"#65C466"}}}),label:"浏览器 (Prefer In Browser)"})))),e.createElement(m,{sx:{...o,...I(S())}},e.createElement(u,{id:"settings_2_4",sx:{fontSize:"0.89rem",fontWeight:500}},"Default Image Style"),e.createElement(u,{sx:l},"默认填充的图片样式，大小，位置等,w表示大小, c表示center, s表示shadow"),e.createElement(ne,{fullWidth:!0,margin:"normal",name:"basicStyle",label:"基本样式",value:M().advanced.imageSettings.basicStyle,onChange:v})),e.createElement(m,{sx:{...o,...I(S())}},e.createElement(u,{id:"settings_2_5",sx:{fontSize:"0.89rem",fontWeight:500}},"Default Stored Path"),e.createElement(u,{sx:l},'默认粘贴图片上传的路径，如设置为"images"，则图片会上传到名根目录的一个为"images"的文件夹下，如该项为空，则保持默认的"images"文件夹'),e.createElement(ne,{disabled:M().advanced.imageSettings.modePrefer==="vf",fullWidth:!0,margin:"none",name:"imgStorePath",label:"图片存储路径",value:M().advanced.imageSettings.imgStorePath,onChange:B})))))}),ye=({content:r,id:t})=>e.createElement(e.Fragment,null,e.createElement(u,{id:t,sx:{mt:"5px",fontSize:"22px",fontWeight:700}},r),e.createElement(V,null)),R=window.React;function Ut(r){const{t}=H();Ie().palette;const n=S();R.useRef();let[a,o]=R.useState(!1);R.useState("");let l=x=>{o(()=>!1),r.onClick(x),r.closeAll()};return R.createElement(R.Fragment,null,R.createElement(J,{fullScreen:!1,maxWidth:!1,open:r.open,onClose:l,sx:{height:"100vh"}},R.createElement(m,{sx:{background:n==="light"?"#F8FAFB":"",padding:"1rem",height:"68vh",width:"70vw"}},R.createElement(Ft,null),R.createElement(V,{sx:{my:.5}}),R.createElement(m,{sx:{height:"58vh",display:"flex",background:n==="light"?"#F8FAFB":"",padding:"5px",flexDirection:"row",borderRradius:"50px",borderRadius:"5px"}},R.createElement(ut,null),R.createElement(Bt,null)))),R.createElement(Ge,null),t("t-settings"))}class C{static instance=null;static userId=null;static peers=new Map;dataChannels=new Map;ws=null;knownUsers=new Set;setMsgFromSharing=()=>{};setFileFromSharing=()=>{};fileMetaInfo={name:"default_received_file"};constructor(){const t=ht().memorable;C.userId=t.localLANId!=="none"?t.localLANId:this.generateUUID(),t.localLANId==="none"&&Re({memorable:{localLANId:C.userId}}),this.knownUsers.add(C.userId)}static getInstance(){return C.instance||(C.instance=new C),C.instance}getUniqId(){return C.userId}async connect(t,n,a,o){try{this.setMsgFromSharing=n,this.setFileFromSharing=a;const l=this.getUniqId();this.ws=new WebSocket(t),this.ws.onopen=()=>{this.broadcastSignal({type:"discover",id:l})},this.ws.onmessage=x=>this.handleSignal(x,o),this.ws.onclose=()=>this.cleanUpConnections(o),this.ws.onerror=x=>console.error("WebSocket error:",x),window.addEventListener("beforeunload",()=>this.disconnect()),window.addEventListener("pagehide",()=>this.disconnect())}catch(l){console.log(l)}}async disconnect(t,n){n&&t&&(n(null),t(null)),this.broadcastSignal({type:"leave",id:this.getUniqId()}),this.cleanUpConnections()}cleanUpConnections(t){this.ws&&(this.ws.onclose=null,this.ws.close(),this.ws=null),C.peers.forEach(n=>n.close()),C.peers.clear(),this.dataChannels.clear(),this.knownUsers.clear(),this.knownUsers.add(C.userId),t&&t(this.getAllUsers())}async handleSignal(t,n){const a=new FileReader;a.readAsText(t.data,"utf-8"),a.onload=async()=>{const o=JSON.parse(a.result);if(o)switch(o.type){case"offer":await this.handleOffer(o);break;case"answer":await this.handleAnswer(o);break;case"candidate":await this.handleCandidate(o);break;case"discover":await this.handleDiscover(o,n);break;case"leave":this.handleLeave(o,n);break;default:console.warn("Unknown message type",o.type)}}}async handleDiscover(t,n){const a=t.id;this.knownUsers.has(a)||(this.knownUsers.add(a),await this.connectToUser(a),n(this.getAllUsers()),this.broadcastSignal({type:"discover",id:this.getUniqId()}))}handleLeave(t,n){const a=t.id;if(this.knownUsers.has(a)){this.knownUsers.delete(a);const o=C.peers.get(a);o&&(o.close(),C.peers.delete(a));const l=this.dataChannels.get(a);l&&(l.close(),this.dataChannels.delete(a)),n(this.getAllUsers()),console.log(`User ${a} has left, cleaned up resources.`)}}createPeerConnection(t){const n=new RTCPeerConnection({iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun.metered.ca:3478","stun:stun.cloudflare.com:3478"]},{urls:"turn:md.metered.live:3478",username:"f003818b5eed7f4ff58ba654",credential:"bvU4/Kv9FXr6lT6O"}]});return n.onicecandidate=a=>{a.candidate&&this.broadcastSignal({type:"candidate",candidate:a.candidate,to:t})},n.ondatachannel=a=>{this.setupDataChannel(a.channel,t)},t&&C.peers.set(t,n),n}broadcastSignal(t){if(this.ws&&this.ws.readyState===WebSocket.OPEN){const n={...t,from:C.userId};this.ws.send(JSON.stringify(n))}}getAllUsers(){return Array.from(this.knownUsers).filter(t=>t!==this.getUniqId())}async handleOffer(t){const n=this.createPeerConnection(t.from);await n.setRemoteDescription(new RTCSessionDescription(t.offer));const a=await n.createAnswer();await n.setLocalDescription(a),this.broadcastSignal({type:"answer",answer:n.localDescription,to:t.from})}async handleAnswer(t){const n=C.peers.get(t.from);n&&await n.setRemoteDescription(new RTCSessionDescription(t.answer))}async handleCandidate(t){const n=C.peers.get(t.from);n&&await n.addIceCandidate(new RTCIceCandidate(t.candidate))}setupDataChannel(t,n){t.binaryType="arraybuffer",t.onopen=()=>{console.log(`Data channel with user ${n} is open`)};let a=null;t.onmessage=o=>{if(typeof o.data=="string"){const l=JSON.parse(o.data);l.type==="file-meta"?(a={name:l.name,size:l.size,receivedSize:0,chunks:[]},F.fileMetaInfo.name=l.name):this.setMsgFromSharing(l.msg)}else if(o.data instanceof ArrayBuffer)if(a){if(a.chunks.push(o.data),a.receivedSize+=o.data.byteLength,a.receivedSize>=a.size){const l=new Blob(a.chunks);URL.createObjectURL(l),this.setFileFromSharing(l),a=null}}else console.error("Received file data but no file metadata available.")},t.onclose=()=>{console.log(`Data channel with user ${n} is closed`),this.dataChannels.delete(n)},this.dataChannels.set(n,t)}async connectToUser(t){if(!C.peers.has(t)){const n=this.createPeerConnection(t),a=n.createDataChannel("chat");this.setupDataChannel(a,t);const o=await n.createOffer();await n.setLocalDescription(o),this.broadcastSignal({type:"offer",offer:n.localDescription,to:t})}}async sendMessageToUser(t,n){const a=this.dataChannels.get(t);a?.readyState==="open"?a.send(JSON.stringify({msg:n,type:"text"})):console.error(`Data channel with user ${t} is not available.`)}async sendFileToUser(t,n){const a=this.dataChannels.get(t);if(!a||a.readyState!=="open"){console.error(`Data channel with user ${t} is not available.`);return}const o=16*1024;let l=0;const x=()=>{const b=n.slice(l,l+o),k=new FileReader;k.onload=()=>{k.result&&(a.send(k.result),l+=o,l<n.size&&x())},k.onerror=v=>{console.error("File read error:",v)},k.readAsArrayBuffer(b)};a.send(JSON.stringify({type:"file-meta",name:n.name,size:n.size})),x()}generateUUID(){return"ID"+Math.random().toString(36).substring(2,11)}isConnected(){return this.ws!==null&&this.ws.readyState===WebSocket.OPEN}getConnectedUserIds(){return this.getAllUsers()}}const F=C.getInstance(),s=window.React,Lt=window.React.useCallback,Wt=window.React.useEffect,_=window.React.useState,ke=(await K("https://cdn.jsdmirror.com/npm/gsap@3.12/+esm")).default,te=(await K("https://cdn.jsdmirror.com/npm/bigonion-kit@0.12.6/esm/kit.min.js")).default,ve="wss://md-server-md-server-bndnqhexdf.cn-hangzhou.fcapp.run";function Pt(r){const t={borderRadius:"12px",borderColor:"#e0e0e0"},{t:n}=H(),a=S(),[o,l]=_(null),[x,b]=_(null),[k,v]=_(!1),[B,f]=_([]),[z,U]=_(!1),[T,N]=_(null),[q,G]=_(null),[X,i]=_(null),y=p=>{const w=p.target.files?.[0]||null;w&&(G(w),N("file"))},Y=()=>{i(ae()),N("text")};async function se(){U(!0);try{F.isConnected()||await F.connect(ve,l,b,f),F.broadcastSignal({type:"discover",id:F.getUniqId()}),await te.sleep(500)}catch(p){console.error("Search error:",p)}finally{U(!1)}}const ie=Lt(p=>{const w=p.currentTarget,W=(A,h)=>{const Q=document.createElement("div");w.appendChild(Q);const Z=w.getBoundingClientRect(),ee=Math.max(Z.width,Z.height),Ue=p.clientX-Z.left-ee/2,Le=p.clientY-Z.top-ee/2;ke.set(Q,{width:ee,height:ee,x:Ue,y:Le,borderRadius:"50%",opacity:1,backgroundColor:"rgba(255, 255, 255, 0.5)",position:"absolute",pointerEvents:"none",transform:"scale(0)"}),ke.fromTo(Q,{scale:0,opacity:1},{scale:h,opacity:0,duration:2.2,ease:"power2.out",delay:A,onComplete:()=>{Q.remove()}})};W(0,2),W(.2,2)},[]),L=async(p,w)=>{const W=ae();try{if(await F.connectToUser(w),console.log(`Connected to user ${w}`),T==="file"&&q)await F.sendFileToUser(w,q);else if(T==="text"&&X)await F.sendMessageToUser(w,X);else if(T==="clip"){let A=ft();await F.sendMessageToUser(w,await A)}else await F.sendMessageToUser(w,W);console.log(`Message sent to user ${w}`)}catch(A){console.error(`Failed to send message to user ${w}:`,A)}};Wt(()=>(r.open&&F.connect(ve,p=>{l(p),v(!0)},p=>{b(p),v(!0)},f).catch(p=>{console.error("Failed to connect:",p)}),()=>{F.disconnect(l,b)}),[r.open]);const ce=()=>{try{if(o)o?(Et("成功收到文本",2e3,{kind:"success"}),we(window.monaco,window.editor,o)):we(window.monaco,window.editor,o);else if(x){const p=new Blob([x]),w=F.fileMetaInfo.name,W=URL.createObjectURL(p),A=document.createElement("a");A.href=W,A.download=w,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(W)}v(!1),te.sleep(500).then(()=>{b(null),l(null)})}catch(p){console.error("Failed to accept message:",p)}},de=p=>{r.onClick(p),r.closeAll()};return s.createElement(s.Fragment,null,s.createElement(J,{hideBackdrop:!0,fullScreen:!1,maxWidth:!1,open:r.open,onClose:de,sx:{height:"100svh",width:"100svw"}},s.createElement(m,{sx:{height:"67svh",width:"55svw",display:"flex",background:a==="light"?"#F8FAFB":"#2B2B2B",padding:"24px",flexDirection:"column",boxShadow:"0 8px 16px rgba(0, 0, 0, 0.2)",justifyContent:"space-between",alignItems:"center",gap:"24px"}},s.createElement(m,{sx:{width:"100%",justifyContent:"flex-start",display:"flex",gap:"12px"}},s.createElement(me,{color:"primary",badgeContent:T==="file"?1:0,overlap:"circular",sx:{"& .MuiBadge-badge":{top:"-2px",right:"-2px"}}},s.createElement(O,{variant:"outlined",sx:t,startIcon:s.createElement(Ye,null),onClick:()=>document.getElementById("file-input")?.click()},"文件")),s.createElement("input",{id:"file-input",type:"file",style:{display:"none"},onChange:y}),s.createElement(O,{disabled:!0,variant:"outlined",startIcon:s.createElement(Fe,null),sx:t},"文件夹"),s.createElement(me,{sx:{"& .MuiBadge-badge":{top:"-2px",right:"-2px"}},color:"primary",badgeContent:T==="text"?1:0,overlap:"circular"},s.createElement(O,{onClick:Y,variant:"outlined",startIcon:s.createElement(Ke,null),sx:t},"Markdown文本")),s.createElement(me,{sx:{"& .MuiBadge-badge":{top:"-2px",right:"-2px"}},color:"primary",badgeContent:T==="clip"?1:0,overlap:"circular"},s.createElement(O,{onClick:()=>{N("clip")},variant:"outlined",startIcon:s.createElement(Qe,null),sx:t},"剪贴板"))),s.createElement(m,{sx:{width:"100%",height:"100%",justifyContent:"flex-start",flexDirection:"column",display:"flex"}},s.createElement(m,{sx:{mb:"10px"}},s.createElement(Ze,{sx:t,onClick:se,endIcon:s.createElement(et,null),loading:z,loadingPosition:"end",variant:"contained"},"搜索同WIFI下用户")),s.createElement(V,null),s.createElement(m,{sx:{width:"100%",height:"100%",justifyContent:"flex-start",flexDirection:"column",display:"flex"}},s.createElement(gt,{sx:{userSelect:"none",width:"100%",height:"100%"}},B.map((p,w)=>s.createElement(m,{sx:{...P,boxShadow:"0px 4px 12px rgba(0, 0, 0, 0.1)",position:"relative",overflow:"hidden",cursor:"pointer"},key:w,onClick:W=>{ie(W),L(W,p)}},s.createElement(pt,{ali:"center",jus:"center",space:[5]},s.createElement(m,{sx:{height:"100%"},className:"FLEX ALI-CEN JUS-CEN"},s.createElement(tt,null)),s.createElement("p",null,p)),s.createElement("span",{className:"ripple",style:{background:"transparent",position:"absolute",borderRadius:"50%",pointerEvents:"none",transform:"scale(0)"}})))),s.createElement(m,{className:"FLEX ALI-CEN JUS-CEN"},s.createElement("p",{style:{color:"#8B8A8A"}},"你的ID: ",F.getUniqId())))))),s.createElement(J,{hideBackdrop:!0,open:k,onClose:()=>{v(!1),te.sleep(500).then(()=>{b(null),l(null)})}},s.createElement(le,null,"✨新分享"),s.createElement(oe,null,s.createElement(ue,null,"您有来自外部的消息，是否接受？"),o?s.createElement(m,{sx:{width:"100%",height:300,overflow:"auto",padding:2,border:"1px solid #ccc",borderRadius:"4px",backgroundColor:"#f9f9f9",whiteSpace:"pre-wrap",fontFamily:"monospace",fontSize:14}},o):s.createElement(s.Fragment,null)),s.createElement(re,null,s.createElement(O,{onClick:()=>{v(!1),te.sleep(500).then(()=>{b(null),l(null)})},color:"secondary"},"拒绝"),s.createElement(O,{onClick:ce,color:"primary",autoFocus:!0},"接受"))),s.createElement(nt,null),s.createElement(u,null,n("t-collaborative-office")))}const c=window.React,dn=Be(()=>{const{t:r}=H(),t=Ct(),[n,a]=c.useState(null),[o,l]=c.useState(null),[x,b]=c.useState(null),[k,v]=c.useState(null),[B,f]=c.useState(null),[z,U]=c.useState(!1),T=!!n,N=!!o,q=!!x,G=!!k,X=!!B,i=h=>{a(h.currentTarget)},y=h=>{l(h.currentTarget),h.stopPropagation()},Y=async h=>{await bt()?(b(h.target),h.stopPropagation()):(h.stopPropagation(),L(),U(!0))},se=h=>{v(h.currentTarget)},ie=h=>{f(h.currentTarget)},L=()=>{a(null)},ce=h=>{l(null),h.stopPropagation()},de=h=>{b(null),h.stopPropagation()},p=h=>{v(null),h.stopPropagation()},w=h=>{f(null),h.stopPropagation()},W=()=>{t.display(),L()},A=()=>{wt(!0),L()};return c.createElement("div",null,c.createElement(J,{open:z,onClose:()=>{U(!1)}},c.createElement(le,null,c.createElement(u,{variant:"h6",gutterBottom:!0},"确定导出吗，你还没有保存呢！")),c.createElement(oe,null,c.createElement(ue,null,c.createElement(u,{variant:"body1",gutterBottom:!0},'Once you have clicked the "yes" button, your text will be saved.'))),c.createElement(re,null,c.createElement(O,{onClick:()=>{U(!1),xt(),Ae()}},"是嘟"),c.createElement(O,{onClick:()=>{U(!1)},autoFocus:!0},"达咩"))),c.createElement(St,{open:T,endIcon:c.createElement(at,null),onClick:i},r("t-more")),c.createElement(he,{id:"demo-customized-menu",MenuListProps:{"aria-labelledby":"demo-customized-button"},elevation:24,anchorEl:n,open:T,onClose:L},c.createElement(g,{onClick:W,disableRipple:!0},c.createElement(lt,null),r("t-image-manager")),c.createElement(g,{onClick:A,disableRipple:!0},c.createElement(Fe,null),r("t-file-manager")),c.createElement(g,{onClick:h=>{Y(h)},disableRipple:!0},c.createElement(Mt,{anchorEl:x,open:q,closeMenu:L,closeExportMenu:de})),c.createElement(V,{sx:{my:.5}}),c.createElement(g,{onClick:h=>{y(h)},disableRipple:!0},c.createElement(kt,{closeAll:L,anchorEl:o,open:N,onClick:ce})),c.createElement(g,{onClick:h=>{ie(h)},disableRipple:!0},c.createElement(Pt,{closeAll:L,anchorEl:B,closeMenu:L,open:X,onClick:w})),c.createElement(g,{onClick:h=>{se(h)},disableRipple:!0},c.createElement(Ut,{closeAll:L,anchorEl:k,open:G,onClick:p})),c.createElement(g,{onClick:()=>{L()},disableRipple:!0},c.createElement(ot,null),r("t-more-coming-soon"))))});export{dn as default};
