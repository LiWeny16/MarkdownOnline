import{R as e,r}from"./react-0d9c9f23.js";import{o as H}from"./mobx-react-49086c1a.js";import{g as F}from"./gsap-cf87e9ff.js";import{y as X,a3 as Z,B as d,U as Y,w as ee,aZ as _,b as v,a_ as te,a$ as oe,aG as re,b0 as ae,x as ne,b1 as se}from"./@mui-76281df7.js";import{a as z,x as le,y as ie,z as ce,A as pe}from"./index-04584e35.js";import"./@babel-518c05f7.js";import"./mobx-890d6d9e.js";import"./mobx-react-lite-64872c2a.js";import"./react-dom-b710246a.js";import"./scheduler-765c72db.js";import"./use-sync-external-store-3bf5d15d.js";import"./clsx-29d81c80.js";import"./@emotion-c98c060d.js";import"./hoist-non-react-statics-3f8ebaa8.js";import"./stylis-79144faa.js";import"./react-transition-group-5217f7e1.js";import"./@popperjs-61ffd834.js";import"./prop-types-c01d55b3.js";import"./react-is-11039b32.js";import"./monaco-editor-5cf1114e.js";/* empty css                      */import"./i18next-2edfafb0.js";import"./@dnd-kit-b0134b90.js";import"./markdown-it-multimd-table-766322c9.js";import"./markdown-it-github-toc-d2e55c92.js";import"./uslug-b4eaf0e7.js";import"./unorm-1228fe77.js";import"./markdown-it-task-lists-4fbe77b0.js";import"./markdown-it-emoji-66d1da7f.js";import"./react-i18next-093df503.js";import"./@monaco-editor-41149cb1.js";import"./state-local-dd516420.js";import"./html2canvas-a81bcda4.js";import"./react-resizable-44dc0d2e.js";import"./react-draggable-4a1d91b3.js";import"./i18next-browser-languagedetector-953d2d0b.js";const L="409f1e38b0d8586919166aa6117243f7.AVQTIQqUbGI1g8B5",de="https://open.bigmodel.cn/api/paas/v4/chat/completions";class me{static token=L;abortController=null;abortCurrentRequest(){this.abortController&&(this.abortController.abort(),this.abortController=null)}async askAI(m,E,i,a,u,f){const D=()=>f?[{type:"image_url",image_url:{url:f}},{type:"text",text:m}]:m,W={model:f?"GLM-4V-Plus-0111":"GLM-4-flash",tool:"web-search-pro",stream:!0,messages:[{role:"system",content:"你是专业的Markdown写作助手，提供简洁准确的内容，直接输出可用的Markdown格式文本，不用代码块包裹。"},{role:"system",content:"格式规范：数学公式用$包裹（行内）或$$包裹（块级）；图表用正确的mermaid语法；保持层次清晰。"},{role:"system",content:E?`用户选中文本："${E}"，请根据要求处理此文本（修改/扩写/优化等），未指明则默认优化。`:"根据用户问题提供相应的Markdown内容。"},{role:"user",content:D()}]};try{this.abortController=new AbortController;const n=await fetch(de,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`${L}`},body:JSON.stringify(W),signal:this.abortController.signal});if(!n.body)throw new Error("ReadableStream not supported in this browser.");const k=n.body.getReader(),h=new TextDecoder("utf-8");let R=!1,c="";for(;!R;){if(this.abortController.signal.aborted){a(c);return}const{value:I,done:g}=await k.read();if(R=g,I){const b=h.decode(I,{stream:!0}).split(`
`).filter(s=>s.trim()!=="");for(const s of b)if(s.startsWith("data:")){const x=s.replace("data:","").trim();if(x==="[DONE]"){a(c),this.abortController=null;return}try{const C=JSON.parse(x).choices[0].delta?.content;C&&(c+=C,i(C))}catch(l){console.error("JSON parse error:",l),u(l)}}}}this.abortController=null}catch(n){if(this.abortController=null,n.name==="AbortError"){a("回答已中断");return}console.error("Error:",n),u(n)}}}const N=new me,O=".prompt-panel-content",w=e.memo(X("button")(({theme:P})=>({background:"none",border:"none",cursor:"pointer",padding:0,"&:hover":{backgroundColor:z()==="light"?"rgba(238, 238, 238, 0.9)":"rgba(66, 165, 245, 0.9)",borderColor:"#0062cc",transition:"background-color 0.4s ease-in-out, opacity 0.4s ease-in-out"},"&:disabled":{opacity:.5,cursor:"not-allowed"},transition:"background-color 0.4s ease-in-out, opacity 0.4s ease-in-out",color:z()==="light"?"black":"white",height:"6svh",minWidth:"60px",fontSize:"0.83rem",borderRadius:"55px",display:"flex",alignItems:"center",justifyContent:"center"}))),Ve=H(function(m){const E={posx:window.document.body.clientWidth/4,posy:window.document.body.clientHeight/2.5},i=r.useRef(null),a=r.useRef(null),u=r.useRef(null),[f,D]=r.useState(!1),[W,n]=r.useState(!1),[k,h]=r.useState(""),[R,c]=r.useState(!1),[I,g]=r.useState(!1),[p,b]=r.useState(!1),[s,x]=r.useState(""),l=r.useRef(null);e.useEffect(()=>{a.current&&setTimeout(()=>{a.current.focus()},100),D(m.open),m.open?F.fromTo(O,{x:0},{x:20,opacity:1,duration:.6}):F.to(O,{opacity:0,duration:.4,onComplete:()=>{}})},[m.open]);const B=()=>{pe({unmemorable:{aiPanelState:!1}})},C=t=>{i.current&&!i.current.contains(t.target)&&B()},U=t=>{i.current&&!i.current.contains(t.target)&&(B(),t.preventDefault())},j=t=>{p||t.ctrlKey&&t.key==="Enter"&&(T(),a.current.value="")},G=t=>{if(t.clipboardData&&t.clipboardData.items)for(let o=0;o<t.clipboardData.items.length;o++){const y=t.clipboardData.items[o];if(y.type.indexOf("image")!==-1){const S=y.getAsFile();if(S){const A=new FileReader;A.onload=M=>{const V=M.target?.result;x(V)},A.readAsDataURL(S)}}}},q=()=>{l.current?.click()},J=t=>{const o=t.target.files;if(o&&o.length>0){const y=o[0],S=new FileReader;S.onload=A=>{const M=A.target?.result;x(M)},S.readAsDataURL(y)}},T=()=>{const t=a.current.value;!t||p||(n(!0),h(""),g(!0),c(!1),b(!0),N.askAI(t,ie(),o=>{u.current&&u.current.scrollTo(0,1e4),h(y=>y+o),g(!1)},o=>{h(o),c(!0),b(!1)},o=>{console.error("AI 请求错误:",o),h("抱歉，发生了错误，可能是宿主没充钱，请联系他olderonion@gmail.com :("),g(!1),b(!1)},s),a.current.value="",$())},K=()=>{N.abortCurrentRequest(),b(!1),g(!1),c(!0)},$=()=>{l.current&&(l.current.value=""),x("")},Q=()=>{ce(k,!1)};return e.createElement(e.Fragment,null,e.createElement(Z,{invisible:!0,transitionDuration:{appear:500,enter:500,exit:1e3},sx:{zIndex:t=>t.zIndex.drawer+1,pointerEvents:f?"auto":"none"},open:f,onContextMenu:U,onMouseUp:C},e.createElement(d,{ref:i,className:"prompt-panel-content",onClick:t=>{t.preventDefault(),t.stopPropagation()},sx:{width:"50svw",position:"absolute",display:"flex",flexDirection:"column",top:E.posy-window.document.body.clientHeight*.1,left:E.posx-window.document.body.clientWidth*.02,borderRadius:"25px",boxShadow:"7px 6px 12px 7px rgb(0 0 0 / 21%)",backgroundColor:z()==="light"?"white":"#333"}},W?e.createElement(e.Fragment,null,e.createElement(d,{sx:{padding:"21px 2vw 4px 16px"}},e.createElement(le,{ref:u,sx:{height:"20svh",width:"48svw"}},e.createElement(Y,{variant:"body1",gutterBottom:!0,sx:{whiteSpace:"pre-wrap"}},I?"AI 正在思考中...":k))),e.createElement(ee,null)):null,e.createElement(d,{className:"FLEX COW",sx:{alignItems:"flex-end"}},e.createElement(d,{sx:{padding:"21px 6px 4px 16px",ml:1,flex:"0 0 89%"}},e.createElement(_,{autoFocus:!0,multiline:!0,disabled:p,className:"transparent-scrollbar",onKeyDown:j,onPaste:G,fullWidth:!0,inputRef:a,maxRows:5,placeholder:p?"AI正在回答中，请稍候...":"Search in GLM-4 AI Model",inputProps:{"aria-label":"search google maps"}})),e.createElement(d,{sx:{position:"relative",display:"inline-block"}},p?e.createElement(v,{title:"中断回答"},e.createElement(w,{style:{padding:"0px 20px",fontWeight:"700",backgroundColor:"#f44336",color:"white",minWidth:"60px",height:"6svh",transform:"scale(1)"},onClick:K,"aria-label":"中断"},e.createElement(te,{style:{fontSize:"1.2rem"}}))):e.createElement(w,{style:{padding:"0px 20px",fontWeight:"700",minWidth:"60px",height:"6svh",transform:"scale(1)"},onClick:T,"aria-label":"发送",disabled:p},e.createElement(oe,{style:{fontSize:"1.2rem"}})))),e.createElement(d,{className:"FLEX COW"},e.createElement(v,{title:"Ctrl+J"},e.createElement(w,{style:{padding:"0px 20px",fontWeight:"700"}},e.createElement(re,{style:{fontSize:"1.2rem",marginRight:"4px"}})," Ask AI")),e.createElement(v,{title:"选择图片"},e.createElement(w,{onClick:q,"aria-label":"选择图片",style:{padding:"0px 20px",fontWeight:"700"}},e.createElement(ae,{style:{fontSize:"1.2rem"}}))),e.createElement(_,{multiline:!0,disabled:!0,fullWidth:!0,sx:{ml:1,flex:1},maxRows:5,placeholder:"Press Ctrl + Enter To Send",inputProps:{"aria-label":"search google maps"}}),s&&e.createElement(d,{sx:{ml:1,position:"relative",display:"inline-block"}},e.createElement("img",{src:s,alt:"图片预览",style:{width:35,height:35,borderRadius:"1px",objectFit:"cover"}}),e.createElement(w,{onClick:()=>$(),"aria-label":"删除图片",style:{position:"absolute",top:-8,right:-8,backgroundColor:"rgba(255,255,255,0.8)",borderRadius:"50%",width:20,height:20,padding:0,zIndex:1}},e.createElement(ne,{style:{fontSize:16}}))),e.createElement(v,{title:"接受AI并插入编辑器"},e.createElement(w,{onClick:Q,"aria-label":"插入",disabled:!R,style:{padding:"0px 20px",fontWeight:"700"}},e.createElement(se,{style:{fontSize:"1.2rem"}})))))),e.createElement("input",{type:"file",accept:"image/*",ref:l,style:{display:"none"},onChange:J}))});export{Ve as default};
